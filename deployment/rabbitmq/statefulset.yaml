---
apiVersion: apps/v1beta1
kind: StatefulSet
metadata:
  name: rabbitmq
  namespace: rabbitmq
  labels:
    app: rabbitmq
spec:
  serviceName: rabbitmq
  replicas: 1
  template:
    metadata:
      labels:
        app: rabbitmq
    spec:
      serviceAccountName: rabbitmq
      terminationGracePeriodSeconds: 10
      initContainers:
      - name: tmp
        image: busybox
        command:
        - 'sh'
        - '-c'
        - >
          wget -O /tmp/delay_plugin.zip https://dl.bintray.com/rabbitmq/community-plugins/3.7.x/rabbitmq_delayed_message_exchange/rabbitmq_delayed_message_exchange-20171201-3.7.x.zip;
          unzip /tmp/delay_plugin.zip -d /tmp/rabbitmq;
        volumeMounts:
        - name: tmp-rabbitmq
          mountPath: /tmp/rabbitmq
      containers:
      - name: rabbitmq-autocluster
        image: rabbitmq:3.7
        imagePullPolicy: Always
        command:
        - /tmp/script.sh
        ports:
        - name: http
          containerPort: 15672
        - name: amqp
          containerPort: 5672
        - name: epmd
          containerPort: 4369
        # livenessProbe:
        #   exec:
        #     command: ["rabbitmqctl", "status"]
        #   initialDelaySeconds: 30
        #   timeoutSeconds: 5
        # readinessProbe:
        #   exec:
        #     command: ["rabbitmqctl", "status"]
        #   initialDelaySeconds: 10
        #   timeoutSeconds: 5
        env:
        - name: MY_POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
        - name: RABBITMQ_USE_LONGNAME
          value: "true"
        - name: RABBITMQ_NODENAME
          value: "rabbit@$(MY_POD_IP)"
        - name: AUTOCLUSTER_TYPE
          value: "k8s"
        - name: AUTOCLUSTER_DELAY
          value: "10"
        - name: K8S_ADDRESS_TYPE
          value: "ip"
        - name: AUTOCLUSTER_CLEANUP
          value: "true"
        - name: CLEANUP_WARN_ONLY
          value: "false"
        - name: K8S_SERVICE_NAME
          value: "rabbitmq"
        - name: RABBITMQ_ERLANG_COOKIE
          valueFrom:
            secretKeyRef:
              name: cookie
              key: rabbitmq.cookie
#         resources:
#           requests:
#
#             memory: "512Mi"
#
#
#             cpu: "100m"
#
#           limits:
#
#             memory: "512Mi"
#
#
#             cpu: "100m"
#
        volumeMounts:
        - name: config
          mountPath: /etc/rabbitmq
        - name: data
          mountPath: /var/lib/rabbitmq
          subPath: rabbitmq
        - name: script
          mountPath: /tmp/script.sh
          subPath: script.sh
        - name: tmp-rabbitmq
          mountPath: /tmp/rabbitmq
      volumes:
      - name: tmp-rabbitmq
        emptyDir: {}
      - name: config
        configMap:
          name: rabbitmq-config
          items:
          - key: rabbitmq.conf
            path: rabbitmq.conf
          - key: rabbitmq.definitions
            path: definitions.json
          - key: rabbitmq.plugins
            path: enabled_plugins
      - name: script
        configMap:
          name: rabbitmq-config
          defaultMode: 0755
  volumeClaimTemplates:
  - metadata:
      name: data
      labels:
        app: volume
        component: rabbitmq
        role: services
    spec:
      accessModes:
      - "ReadWriteOnce"
      storageClassName: fast
      resources:
        requests:
          storage: 1Gi
