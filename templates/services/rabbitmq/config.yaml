---
apiVersion: v1
kind: Secret
metadata:
  name: cookie
  namespace: {{.rabbitmq.namespace}}
  labels:
    app: rabbitmq
type: Opaque
data:
  rabbitmq.cookie: {{.rabbitmq.cookie}}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: rabbitmq-config
  namespace: {{.rabbitmq.namespace}}
  labels:
    app: rabbitmq
data:
  # script.sh: |
  #   #!/usr/bin/env sh
  #   # echo ${ERLANG_COOKIE} > /var/lib/rabbitmq/.erlang.cookie
  #   # # echo ${RABBITMQ_ERLANG_COOKIE} > ~/.erlang.cookie
  #   # chown -R rabbitmq: /var/lib/rabbitmq/
  #   cp /tmp/rabbitmq/* /plugins/
  #   rabbitmq-plugins enable rabbitmq_delayed_message_exchange --offline
  #   # rabbitmq-plugins enable rabbitmq_peer_discovery_k8s rabbitmq_consistent_hash_exchange rabbitmq_delayed_message_exchange rabbitmq_top rabbitmq_federation rabbitmq_federation_management rabbitmq_management rabbitmq_mqtt rabbitmq_shovel rabbitmq_shovel_management rabbitmq_stomp rabbitmq_web_stomp --offline
  #   docker-entrypoint.sh "rabbitmq-server"
  enabled_plugins: |
    [rabbitmq_management,rabbitmq_peer_discovery_k8s,rabbitmq_consistent_hash_exchange,rabbitmq_delayed_message_exchange,rabbitmq_top,rabbitmq_federation,rabbitmq_federation_management,rabbitmq_mqtt,rabbitmq_shovel,rabbitmq_shovel_management,rabbitmq_stomp,rabbitmq_web_stomp,rabbitmq_delayed_message_exchange].
  rabbitmq.conf: |
    ## Clustering
    cluster_formation.peer_discovery_backend  = rabbit_peer_discovery_k8s
    cluster_formation.k8s.host = kubernetes.default.svc.cluster.local
    cluster_formation.k8s.address_type = ip
    cluster_formation.node_cleanup.interval = 10
    cluster_formation.node_cleanup.only_log_warning = false
    cluster_partition_handling = autoheal
    ## queue master locator
    queue_master_locator=min-masters
    ## enable guest user
    loopback_users.guest = false
    heartbeat = {{.rabbitmq.heartbeat}}

    listeners.tcp.default = 5672
    default_user = beamery
    default_pass = Ub3rm3nch
    hipe_compile = false
    management.listener.port = 15672
    management.listener.ssl = false

    # management.load_definitions = /tmp/definitions.json
  rabbitmq.definitions: |
    {
      "rabbit_version":"3.7.2",
      "users":[
        {
          "name":"beamery",
          "password_hash":"7CqCKEjEsGMNSHF23c0PZh4sphpXyelXLEWRTdJe1QZWc2Ta",
          "hashing_algorithm":"rabbit_password_hashing_sha256",
          "tags":"administrator"
        },
        {
          "name":"guest",
          "password_hash":"6vcRqyZoeTW38i8+3O4mBWnQ+ZS3/AWVxpJ1bjexrDzbif1n",
          "hashing_algorithm":"rabbit_password_hashing_sha256",
          "tags":"administrator"
        }
      ],
      "vhosts":[
        {
          "name":"/"
        },
        {
          "name":"{{.rabbitmq.vhost_name}}"
        }
      ],
      "permissions":[
        {
          "user":"beamery",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "configure":".*",
          "write":".*",
          "read":".*"
        },
        {
          "user":"beamery",
          "vhost":"/",
          "configure":".*",
          "write":".*",
          "read":".*"
        },
        {
          "user":"guest",
          "vhost":"/",
          "configure":".*",
          "write":".*",
          "read":".*"
        }
      ],
      "topic_permissions":[],
      "parameters":[],
      "global_parameters":[
        {
          "name":"cluster_name",
          "value":"rabbit@rabbitmq-0.rabbitmq.rabbitmq.svc.cluster.local"
        }
      ],
      "policies":[
        {
          "vhost":"{{.rabbitmq.vhost_name}}",
          "name":"Vacancies HA/DLX",
          "pattern":"^vacancies$",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"vacancies:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
        {
          "vhost":"{{.rabbitmq.vhost_name}}",
          "name":"Events HA/DLX",
          "pattern":"^events$",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"events:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
        {
          "vhost":"{{.rabbitmq.vhost_name}}",
          "name":"ha-all",
          "pattern":".*",
          "apply-to":"queues",
          "definition":
            {
              "ha-mode":"all"
            },
          "priority":0
        },
        {
          "vhost":"{{.rabbitmq.vhost_name}}",
          "name":"Contacts Bulk Imports HA/DLX",
          "pattern":"^contactsBulkImports$",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"contactsBulkImports:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
        {
          "vhost":"{{.rabbitmq.vhost_name}}",
          "name":"GH Delay",
          "pattern":"integrations\\.greenhouse:delayed",
          "apply-to":"queues",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"integrations.greenhouse",
              "message-ttl":60000
            },
          "priority":2
        },
        {
          "vhost":"{{.rabbitmq.vhost_name}}",
          "name":"Sherlock HA/DLX",
          "pattern":"^sherlock$",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"sherlock:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
         {
          "vhost":"{{.rabbitmq.vhost_name}}",
          "name":"leaderboards",
          "pattern":"^leaderboards",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"leaderboards:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
        {
          "vhost":"{{.rabbitmq.vhost_name}}",
          "name":"HA",
          "pattern":"^(?!amq\\.).*",
          "apply-to":"queues",
          "definition":
            {
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":-10
        },
        {
          "vhost":"{{.rabbitmq.vhost_name}}",
          "name":"Vacancies DLX",
          "pattern":"^vacancies",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead"
            },
          "priority":1
        },
        {
          "vhost":"{{.rabbitmq.vhost_name}}",
          "name":"Digests HA/DLX",
          "pattern":"^digests$",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"digests:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
        {
          "vhost":"{{.rabbitmq.vhost_name}}",
          "name":"\"All\" HA / DLX",
          "pattern":"^all$",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"all:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
        {
          "vhost":"{{.rabbitmq.vhost_name}}",
          "name":"Workday HA/DLX",
          "pattern":"^integrations\\.workday$",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"integrations.workday:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
        {
          "vhost":"/",
          "name":"ha-all",
          "pattern":".*",
          "apply-to":"queues",
          "definition":
            {
              "ha-mode":"all"
            },
          "priority":0
        },
        {
          "vhost":"{{.rabbitmq.vhost_name}}",
          "name":"Bulk Actions HA/DLX",
          "pattern":"^bulkActions$",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.failed",
              "dead-letter-routing-key":"bulkActions:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
        {
          "vhost":"{{.rabbitmq.vhost_name}}",
          "name":"GH HA/DLX",
          "pattern":"integrations\\.greenhouse",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"integrations.greenhouse:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
        {
          "vhost":"{{.rabbitmq.vhost_name}}",
          "name":"Jobvite HA/DLX",
          "pattern":"integrations\\.jobvite",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"integrations.jobvite:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
        {
          "vhost":"{{.rabbitmq.vhost_name}}",
          "name":"Generic HA/DLX",
          "pattern":"integrations\\.generic",
          "apply-to":"all",
          "definition":
            {
              "dead-letter-exchange":"amqp.dead",
              "dead-letter-routing-key":"integrations.generic:failed",
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        },
        {
          "vhost":"{{.rabbitmq.vhost_name}}",
          "name":"Jobvite Nifi HA/DLX",
          "pattern":"integrations\\.jobvite\\.sync:nifi",
          "apply-to":"all",
          "definition":
            {
              "ha-mode":"all",
              "ha-sync-mode":"automatic"
            },
          "priority":1
        }
      ],
      "queues":[
        {
          "name":"all:failed",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"contactsBulkImports",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"contactsBulkImports:failed",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
                {
          "name":"leaderboards",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"leaderboards:failed",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"vacancies",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"all",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"bulkActions",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"campaigns:failed",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"bulkActions:failed",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"sherlock",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.jazz:failed",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.greenhouse:delayed",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"all-attachments-shovel",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.workday:failed",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"contactsBulkImports:failed-tmp",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.workday",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"events",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"vacancies:failed",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.greenhouse:failed",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"digests:failed",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"sherlock:failed",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"campaigns",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.workday-tmp",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.jazz",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.greenhouse",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.generic",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.jobvite",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.jobvite.sync:nifi",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.jobvite:failed",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"integrations.generic:failed",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"digests",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        },
        {
          "name":"events:failed",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "durable":true,
          "auto_delete":false,
          "arguments":{}
        }
      ],
      "exchanges":[
        {
          "name":"amqp.delayed.campaigns",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "type":"x-delayed-message",
          "durable":true,
          "auto_delete":false,
          "internal":false,
          "arguments": { "x-delayed-type":"direct" }
        },
        {
          "name":"amqp.dead",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "type":"direct",
          "durable":true,
          "auto_delete":false,
          "internal":false,
          "arguments":{}
        },
        {
          "name":"campaigns",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "type":"fanout",
          "durable":true,
          "auto_delete":false,
          "internal":false,
          "arguments":{}
        },
        {
          "name":"web",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "type":"direct",
          "durable":true,
          "auto_delete":false,
          "internal":false,
          "arguments":{}
        },
        {
          "name":"amqp.delayed",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "type":"x-delayed-message",
          "durable":true,
          "auto_delete":false,
          "internal":false,
          "arguments": { "x-delayed-type":"direct" }
        }
      ],
      "bindings":[
        {
          "source":"amqp.dead",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "destination":"all:failed",
          "destination_type":"queue",
          "routing_key":"all:failed",
          "arguments":{}
        },
        {
          "source":"amqp.dead",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "destination":"bulkActions:failed",
          "destination_type":"queue",
          "routing_key":"bulkActions:failed",
          "arguments":{}
        },
        {
          "source":"amqp.dead",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "destination":"campaigns:failed",
          "destination_type":"queue",
          "routing_key":"campaigns:failed",
          "arguments":{}
        },
        {
          "source":"amqp.dead",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "destination":"contactsBulkImports:failed",
          "destination_type":"queue",
          "routing_key":"contactsBulkImports:failed",
          "arguments":{}
        },
        {
          "source":"amqp.dead",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "destination":"digests:failed",
          "destination_type":"queue",
          "routing_key":"digests:failed",
          "arguments":{}
        },
        {
          "source":"amqp.dead",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "destination":"events:failed",
          "destination_type":"queue",
          "routing_key":"events:failed",
          "arguments":{}
        },
        {
          "source":"amqp.dead",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "destination":"integrations.greenhouse",
          "destination_type":"queue",
          "routing_key":"integrations.greenhouse",
          "arguments":{}
        },
        {
          "source":"amqp.dead",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "destination":"integrations.greenhouse:failed",
          "destination_type":"queue",
          "routing_key":"integrations.greenhouse:failed",
          "arguments":{}
        },
        {
          "source":"amqp.dead",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "destination":"integrations.workday:failed",
          "destination_type":"queue",
          "routing_key":"integrations.workday:failed",
          "arguments":{}
        },
        {
          "source":"amqp.dead",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "destination":"sherlock:failed",
          "destination_type":"queue",
          "routing_key":"sherlock:failed",
          "arguments":{}
        },
        {
          "source":"amqp.dead",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "destination":"vacancies:failed",
          "destination_type":"queue",
          "routing_key":"vacancies:failed",
          "arguments":{}
        },
        {
          "source":"amqp.delayed",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "destination":"all",
          "destination_type":"queue",
          "routing_key":"all",
          "arguments":{}
        },
        {
          "source":"amqp.delayed",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "destination":"campaigns",
          "destination_type":"queue",
          "routing_key":"campaigns",
          "arguments":{}
        },
        {
          "source":"amqp.delayed",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "destination":"events",
          "destination_type":"queue",
          "routing_key":"events",
          "arguments":{}
        },
        {
          "source":"amqp.delayed",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "destination":"vacancies",
          "destination_type":"queue",
          "routing_key":"vacancies",
          "arguments":{}
        },
        {
          "source":"amqp.delayed.campaigns",
          "vhost":"{{.rabbitmq.vhost_name}}",
          "destination":"campaigns",
          "destination_type":"queue",
          "routing_key":"campaigns",
          "arguments":{}
        }
      ]
    }
